name: Daily Database Backup

on:
  schedule:
    # Tous les jours Ã  3h du matin (UTC) = 4h heure franÃ§aise
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      upload_to_gcs:
        description: 'Upload backup to Google Cloud Storage'
        type: boolean
        default: true

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  BACKUP_BUCKET: ${{ vars.BACKUP_BUCKET }}
  DATABASE_URL_SECRET: ${{ vars.DATABASE_URL_SECRET }}
  BACKUP_RETENTION_DAYS: ${{ vars.BACKUP_RETENTION_DAYS }}

jobs:
  backup:
    name: Backup Neon Database
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve upload flag
        id: upload-flag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FLAG="${{ github.event.inputs.upload_to_gcs }}"
          else
            FLAG="true"
          fi
          echo "upload=${FLAG}" >> "$GITHUB_OUTPUT"

      - name: Validate required inputs
        run: |
          : "${BACKUP_BUCKET:?BACKUP_BUCKET is required}"
          : "${DATABASE_URL_SECRET:?DATABASE_URL_SECRET is required}"

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_GH_SVC_ACCOUNT_JSON_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install PostgreSQL client 17
        run: |
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates lsb-release
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /usr/share/keyrings/postgresql-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/postgresql-keyring.gpg] http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Verify pg_dump version
        run: pg_dump --version

      - name: Fetch and parse database URL
        id: db-url
        run: |
          DB_URL=$(gcloud secrets versions access latest --secret="${{ env.DATABASE_URL_SECRET }}")
          if [[ -z "$DB_URL" ]]; then
            echo "âŒ Secret ${{ env.DATABASE_URL_SECRET }} is empty" >&2
            exit 1
          fi

          # Normalize scheme for asyncpg URLs
          DB_URL=${DB_URL/postgresql+asyncpg/postgresql}
          export DB_URL

          python - <<'PY'
          import os
          import sys
          from urllib.parse import urlparse

          raw = os.environ.get("DB_URL", "")
          parsed = urlparse(raw)

          if not parsed.scheme.startswith("postgresql"):
              sys.exit("Invalid DATABASE_URL scheme")
          if not parsed.hostname or not parsed.username or not parsed.password or not parsed.path:
              sys.exit("DATABASE_URL missing host/user/password/database")

          db_name = parsed.path.lstrip('/')
          port = parsed.port or 5432

          print(f"::add-mask::{parsed.password}")

          output = os.environ.get("GITHUB_OUTPUT")
          with open(output, "a", encoding="utf-8") as fh:
              fh.write(f"user={parsed.username}\n")
              fh.write(f"password={parsed.password}\n")
              fh.write(f"host={parsed.hostname}\n")
              fh.write(f"port={port}\n")
              fh.write(f"database={db_name}\n")
          PY

      - name: Create backup
        id: backup
        env:
          PGPASSWORD: ${{ steps.db-url.outputs.password }}
        run: |
          TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)
          BACKUP_FILE="budget_backup_${TIMESTAMP}.sql"

          echo "Creating backup: $BACKUP_FILE"
          pg_dump \
            -h "${{ steps.db-url.outputs.host }}" \
            -p "${{ steps.db-url.outputs.port }}" \
            -U "${{ steps.db-url.outputs.user }}" \
            -d "${{ steps.db-url.outputs.database }}" \
            --no-owner \
            --format=plain \
            --no-password \
            > "$BACKUP_FILE"

          gzip "$BACKUP_FILE"
          BACKUP_FILE="${BACKUP_FILE}.gz"

          echo "file=$BACKUP_FILE" >> "$GITHUB_OUTPUT"
          echo "timestamp=$TIMESTAMP" >> "$GITHUB_OUTPUT"

          ls -lh "$BACKUP_FILE"

      - name: Check GCS bucket
        if: steps.upload-flag.outputs.upload != 'false'
        run: |
          if ! gsutil ls "gs://${{ env.BACKUP_BUCKET }}" >/dev/null 2>&1; then
            echo "âŒ Bucket gs://${{ env.BACKUP_BUCKET }} not found. Create it (region ${{ env.REGION }}) and grant the service account Storage Object Admin." >&2
            exit 1
          fi

      - name: Upload to Google Cloud Storage
        if: steps.upload-flag.outputs.upload != 'false'
        run: |
          gsutil cp "${{ steps.backup.outputs.file }}" "gs://${{ env.BACKUP_BUCKET }}/"
          echo "âœ… Backup uploaded to gs://${{ env.BACKUP_BUCKET }}/${{ steps.backup.outputs.file }}"

      - name: List recent backups
        if: steps.upload-flag.outputs.upload != 'false'
        run: |
          echo "ðŸ“¦ Recent backups in GCS:"
          gsutil ls -l "gs://${{ env.BACKUP_BUCKET }}/" | tail -10

      - name: Cleanup local backups
        run: |
          rm -f *.sql.gz
          echo "âœ… Local cleanup done"

      - name: Summary
        run: |
          RETENTION="${{ env.BACKUP_RETENTION_DAYS }}"
          RETENTION="${RETENTION:-30}"

          echo "## ðŸ’¾ Backup Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Timestamp:** ${{ steps.backup.outputs.timestamp }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **File:** ${{ steps.backup.outputs.file }}" >> "$GITHUB_STEP_SUMMARY"
          if [[ "${{ steps.upload-flag.outputs.upload }}" != "false" ]]; then
            echo "- **Storage:** gs://${{ env.BACKUP_BUCKET }}/${{ steps.backup.outputs.file }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- **Storage:** upload skipped" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- **Retention:** ${RETENTION} days" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Backup completed" >> "$GITHUB_STEP_SUMMARY"
