name: Daily Database Backup

on:
  schedule:
    # Tous les jours Ã  3h du matin (UTC) = 4h heure franÃ§aise
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      upload_to_gcs:
        description: 'Upload backup to Google Cloud Storage'
        type: boolean
        default: true

env:
  # Secrets from organization
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  # Variables from repository
  REGION: ${{ vars.GCP_REGION }}
  BACKUP_BUCKET: ${{ vars.BACKUP_BUCKET }}
  DATABASE_URL_SECRET: ${{ vars.DATABASE_URL_SECRET }}
  BACKUP_RETENTION_DAYS: ${{ vars.BACKUP_RETENTION_DAYS }}

jobs:
  backup:
    name: Backup Neon Database
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_GH_SVC_ACCOUNT_JSON_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Get Database URL from Secret Manager
        id: db-url
        run: |
          DB_URL=$(gcloud secrets versions access latest --secret=${{ env.DATABASE_URL_SECRET }})
          # Convert asyncpg URL to psql URL
          PSQL_URL=$(echo "$DB_URL" | sed 's/postgresql+asyncpg/postgresql/')
          echo "::add-mask::$PSQL_URL"
          echo "url=$PSQL_URL" >> $GITHUB_OUTPUT

      - name: Create Backup
        id: backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="budget_backup_${TIMESTAMP}.sql"
          
          echo "Creating backup: $BACKUP_FILE"
          pg_dump "${{ steps.db-url.outputs.url }}" > "$BACKUP_FILE"
          
          # Compress
          gzip "$BACKUP_FILE"
          BACKUP_FILE="${BACKUP_FILE}.gz"
          
          echo "file=$BACKUP_FILE" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          # Show backup info
          ls -lh "$BACKUP_FILE"

      - name: Create GCS Bucket if not exists
        run: |
          RETENTION="${{ env.BACKUP_RETENTION_DAYS }}"
          RETENTION="${RETENTION:-30}"
          
          if ! gsutil ls "gs://${{ env.BACKUP_BUCKET }}" 2>/dev/null; then
            gsutil mb -l ${{ env.REGION }} "gs://${{ env.BACKUP_BUCKET }}"
            # Set lifecycle policy to delete old backups
            cat > /tmp/lifecycle.json << EOF
          {
            "lifecycle": {
              "rule": [
                {
                  "action": {"type": "Delete"},
                  "condition": {"age": ${RETENTION}}
                }
              ]
            }
          }
          EOF
            gsutil lifecycle set /tmp/lifecycle.json "gs://${{ env.BACKUP_BUCKET }}"
            echo "âœ… Bucket created with ${RETENTION}-day retention policy"
          fi

      - name: Upload to Google Cloud Storage
        if: github.event.inputs.upload_to_gcs != 'false'
        run: |
          gsutil cp "${{ steps.backup.outputs.file }}" "gs://${{ env.BACKUP_BUCKET }}/"
          echo "âœ… Backup uploaded to gs://${{ env.BACKUP_BUCKET }}/${{ steps.backup.outputs.file }}"

      - name: List recent backups
        run: |
          echo "ðŸ“¦ Recent backups in GCS:"
          gsutil ls -l "gs://${{ env.BACKUP_BUCKET }}/" | tail -10

      - name: Cleanup old local backups
        run: |
          rm -f *.sql.gz
          echo "âœ… Local cleanup done"

      - name: Summary
        run: |
          RETENTION="${{ env.BACKUP_RETENTION_DAYS }}"
          RETENTION="${RETENTION:-30}"
          echo "## ðŸ’¾ Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** ${{ steps.backup.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** ${{ steps.backup.outputs.file }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage:** gs://${{ env.BACKUP_BUCKET }}/${{ steps.backup.outputs.file }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention:** ${RETENTION} days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backup completed successfully!" >> $GITHUB_STEP_SUMMARY
