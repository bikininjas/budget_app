#!/bin/bash
# Script de migration vers le cloud (GCP, AWS, Azure, ou autre)
# Usage: ./scripts/migrate-to-cloud.sh

set -e

echo "ğŸš€ Assistant de migration vers le cloud"
echo "========================================"
echo ""

# Charger les variables d'environnement si le fichier existe
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

# CrÃ©er un backup avant migration
BACKUP_DIR="./backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/migration_$TIMESTAMP.sql.gz"

echo "ğŸ“¦ Ã‰tape 1: CrÃ©ation du backup..."
./scripts/backup.sh "migration_$TIMESTAMP"

echo ""
echo "ğŸ“‹ Ã‰tape 2: Instructions de migration"
echo "========================================"
echo ""
echo "Le fichier de backup a Ã©tÃ© crÃ©Ã©: $BACKUP_FILE"
echo ""
echo "Choisissez votre plateforme cloud:"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”µ GOOGLE CLOUD PLATFORM (GCP)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. CrÃ©er une instance Cloud SQL PostgreSQL:"
echo "   gcloud sql instances create budget-db \\"
echo "     --database-version=POSTGRES_16 \\"
echo "     --tier=db-f1-micro \\"
echo "     --region=europe-west1"
echo ""
echo "2. CrÃ©er la base de donnÃ©es:"
echo "   gcloud sql databases create budget_db --instance=budget-db"
echo ""
echo "3. CrÃ©er un utilisateur:"
echo "   gcloud sql users create budget_user \\"
echo "     --instance=budget-db \\"
echo "     --password=YOUR_SECURE_PASSWORD"
echo ""
echo "4. Importer le backup (via Cloud Storage):"
echo "   gsutil cp $BACKUP_FILE gs://YOUR_BUCKET/"
echo "   gcloud sql import sql budget-db gs://YOUR_BUCKET/migration_$TIMESTAMP.sql.gz \\"
echo "     --database=budget_db"
echo ""
echo "5. Mettre Ã  jour DATABASE_URL dans votre .env de production"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸŸ  AMAZON WEB SERVICES (AWS)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. CrÃ©er une instance RDS PostgreSQL via la console AWS"
echo ""
echo "2. Se connecter et restaurer:"
echo "   gunzip -c $BACKUP_FILE | psql \\"
echo "     -h YOUR_RDS_ENDPOINT \\"
echo "     -U budget_user \\"
echo "     -d budget_db"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”· MICROSOFT AZURE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. CrÃ©er un serveur Azure Database for PostgreSQL"
echo ""
echo "2. Restaurer via psql:"
echo "   gunzip -c $BACKUP_FILE | psql \\"
echo "     -h YOUR_SERVER.postgres.database.azure.com \\"
echo "     -U budget_user@YOUR_SERVER \\"
echo "     -d budget_db"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ³ AUTRE SERVEUR DOCKER"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. Copier le backup vers le serveur distant:"
echo "   scp $BACKUP_FILE user@server:/path/to/backups/"
echo ""
echo "2. Sur le serveur distant, utiliser le script restore.sh:"
echo "   ./scripts/restore.sh /path/to/backups/migration_$TIMESTAMP.sql.gz"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âœ… Backup prÃªt pour la migration: $BACKUP_FILE"
